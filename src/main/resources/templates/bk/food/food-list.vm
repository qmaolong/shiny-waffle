<!DOCTYPE html>
<html>
<head>
    #parse("templates/common/base-bk.vm")
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>品项分类</title>
     <link href="$URL/asset/bk/css/bootstrap.min14ed.css?v=3.3.6" rel="stylesheet">
    <link href="$URL/asset/bk/css/font-awesome.min93e3.css?v=4.4.0" rel="stylesheet">
    <link href="$URL/asset/bk/css/plugins/jsTree/style.min.css" rel="stylesheet">
    <link href="$URL/asset/bk/css/animate.min.css" rel="stylesheet">
    <link href="$URL/asset/bk/css/style.min862f.css?v=4.1.0" rel="stylesheet">
    <link href="$URL/asset/bk/css/plugins/bootstrap-table/bootstrap-table.min.css" rel="stylesheet">
</head>

<body class="gray-bg">
<div class="wrapper wrapper-content  animated fadeInRight">

    <div class="row">
        <div class="col-xs-3">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>品项分类</small></h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                        <a class="close-link">
                            <i class="fa fa-times"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">

                    <div id="jstree1">
                        <ul>
                            #foreach($category in $!{categories})
                                #set($firstCount = $velocityCount)
                                <li  class="jstree-open" data-jstree='{"type":"second"}'>
                                    $!{category.id}-$!{category.name}
                                    <ul>
                                        #foreach($child in ${category.children})
                                            <li data-jstree='{"type":"third"}'class="#if($velocityCount == 1&&$firstCount == 1)jstree-clicked#end " onclick="refreshChildren('$!{child.id}', '$!{child.name}')">$!{child.id}-$!{child.name}</li>
                                        #end
                                    </ul>

                                </li>
                            #end
                        </ul>
                    </div>

                </div>
            </div>
        </div>
        <div class="col-xs-9">
            <!-- Example Events -->
            <div class="example-wrap">
                <div class="ibox-content">
                    <div id="toolbar" class="btn-group">
                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                            <i class="glyphicon glyphicon-plus"></i>&nbsp;新建<span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu" role="menu">
                            <li><a href="#" id="addSingle">新建单品</a></li>
                            <li class="divider"></li>
                            <li><a href="#" id="addSuite">新建套餐</a></li>
                            #if(!$!shopSuperFlag)
                                <li class="divider"></li>
                                <li><a href="#" id="quoteFromSuper">引用总店的菜</a></li>
                            #end
                        </ul>
                        <div class="btn-group">
                            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" >
                                <i class="glyphicon glyphicon-sort"></i>&nbsp;导入导出<span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu" role="menu">
                                <li><a href="#" id="foodImport">导入</a></li>
                                <li class="divider"></li>
                                <li><a href="#" id="foodOutput">导出</a></li>
                            </ul>
                        </div>
                        <button type="button" class="btn btn-default" id="batchSetPrinters">
                            <i class="fa fa-wrench"></i>&nbsp;批量设置
                        </button>
                        #*<button type="button" class="btn btn-default closeFrame">
                            <i class="glyphicon glyphicon-remove"></i>&nbsp;关闭
                        </button>*#
                    </div>
                    <table id="table" data-height="700"
                           data-toggle="table"
                           data-striped="true"
                           data-query-params="queryParams"
                           data-pagination="true"
                           data-search="true"
                           data-show-refresh="true"
                           data-page-list="[5, 10, 20, 50, 100, 200]"
                           data-page-size="15"
                           data-toolbar="#toolbar" data-mobile-responsive="true"
                           data-show-export="true"
                           data-export-data-type="all"
                           data-export-types="['json', 'xml', 'txt', 'sql', 'excel']">
                        <thead>
                        <tr>
                        ##                                    <th data-field="state" data-checkbox="true"></th>
##                            <th data-formatter="Formatter.runningFormatter">序号</th>
                            <th data-field="id">ID</th>
                            <th data-field="name">名称</th>
                            <th data-field="type" data-formatter="foodTypeFormatter">类型</th>
                            <th data-field="price1">价格1</th>
                            #*<th data-field="price2">价格2</th>
                            <th data-field="price3">价格3</th>*#
                            <th data-field="pricem">会员价</th>
                            <th data-field="foodState" data-formatter="foodStateFormatter">状态</th>
                            <th data-formatter="rudFormatter" data-events="rudEvents">操作</th>
                        </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="$URL/asset/bk/js/jquery.min.js?v=2.1.4"></script>
<script src="$URL/asset/bk/js/bootstrap.min.js?v=3.3.6"></script>
<script src="$URL/asset/bk/js/content.min.js?v=1.0.0"></script>
<script src="$URL/asset/bk/js/plugins/jsTree/jstree.min.js"></script>
<script src="$URL/asset/bk/js/plugins/bootstrap-table/bootstrap-table.min.js"></script>
<script src="$URL/asset/bk/js/plugins/bootstrap-table/bootstrap-table-mobile.min.js"></script>
<script src="$URL/asset/bk/js/plugins/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
<script src="$URL/asset/bk/plugins/layer/layer.js"></script>
<script src="$URL/asset/bk/js/plugins/layer/laydate/laydate.js"></script>
<script src="$URL/asset/bk/js/plugins/validate/jquery.validate.min.js"></script>
<script src="$URL/asset/bk/js/plugins/validate/messages_zh.min.js"></script>
<script src="$URL/asset/bk/js/bootstrap-table-export.js?v=$timestamp"></script>
<script src="$URL/asset/bk/js/tableExport.js"></script>
    #parse("templates/common/foot.vm")
<style>
    .jstree-open>.jstree-anchor>.fa-folder:before{content:"\f07c"}.jstree-default .jstree-icon.none{width:0}
</style>
<script>
    #if(${categories.size()}>0 && $!{categories.get(0)})
        #set($firstCategory=$!{categories.get(0)})
    #end
    #if(${categories.size()}>0 && $!{categories.get(0)} && $!{categories.get(0)} && $!{categories.get(0).children.size()}>0 && $!{categories.get(0).children.get(0)})
        #set($firstChild=$!{categories.get(0).children.get(0)})
    #end

    var localChildrenId = "$!{firstChild.id}";
    var localChildrenName = "$!{firstChild.name}";
    $(document).ready(function () {
        $("#jstree1").jstree({
            "core": {"check_callback": true},
            "plugins": ["types", "dnd"],
            "types": {
                "default": {"icon": "fa fa-tag"},
                "top": {"icon": "glyphicon glyphicon-menu-hamburger"},
                "second" : {"icon": "glyphicon glyphicon-stop"},
                "third" : {"icon": "glyphicon glyphicon-triangle-right"}
            }
        });
    });

    function foodTypeFormatter(value){
        if(value==1){
            return "套餐";
        }else {
            return "单品";
        }
    }

    $("#table").bootstrapTable({
        url: "$URL/merchant/admin/food/getFoodList?cateChildrenId=$!{firstChild.id}",
        responseHandler : "responseHandler",
        onLoadError : function(){errorHandler("#table")}
    });

    function refreshChildren(childId, childName){
        $("input[class='form-control']").val(childName);
        localChildrenName = childName;
        localChildrenId = childId;
        $("#table").bootstrapTable('refresh', {url: '$URL/merchant/admin/food/getFoodList?cateChildrenId=' + childId,
            responseHandler : "responseHandler"});
    }

    function currentChildrenName(){
        return localChildrenName;
    }

    function getCurrentChildrenId(){
        return localChildrenId;
    }

    //初始化增删改查配置
    initEdit({
        name : '菜品',
        addButton : "#addSingle",
        editButton : ".edit",
        deleteButton : ".delete",
        lookButton : ".look",
        layerType : 2,
        content : '$URL/merchant/admin/food/foodInput',
        editUrl : "$URL/merchant/admin/food/editFood",
        area : ['90%', '90%'],
    })

    //大小类联动
    function refreshChildrenOption(){
        var categoryId = $("#categoryId").val();
        var category = getCategoryById(categoryId);
        var children = category.children;
        var options = " ";
        if(undefined != children && children.length > 0){
            jQuery.each(children, function(i, child){
                options += "<option value='" + child.id + "'";
                var currentChildrenId = getCurrentChildrenId();
                if(currentChildrenId == child.id){
                    options += " selected";
                }
                options += ">" + child.name + "</option>";
            })
        }
        console.log(options);
        $("select[name='cat']").html(options);
    }

    //获取大类
    function getCategoryById(cateId){
        var categories = #if($!{categories})$!{categories}#else[]#end;
        var category = null;
        jQuery.each(categories, function(i, cate){
            if(cateId == cate.id){
                category = cate;
            }
        })
        return category;
    }

    //新建套餐
    $("#addSuite").on("click", function(){
        layer.open({
            title:"新建套餐",
            type: 2,
            closeBtn: 1, //不显示关闭按钮
            shift: 2,
            maxmin: true,
            area: ['90%', '90%'],
            shadeClose: true, //开启遮罩关闭
            content: '$URL/merchant/admin/food/foodInput?oper=add&type=1',
            end: function () {
                $("button[name='refresh']").click();
            },
            success : function(layero, index){

            }
        })
    })

    //引用总店的菜
    $("#quoteFromSuper").on("click", function () {
        layer.open({
            title:"引用总店的菜品",
            type: 2,
            closeBtn: 1, //不显示关闭按钮
            shift: 2,
            maxmin: true,
            area: ['90%', '90%'],
            shadeClose: true, //开启遮罩关闭
            content: '$URL/merchant/admin/food/quoteFromSuper',
            end: function () {
                $("button[name='refresh']").click();
            },
            success : function(layero, index){

            }
        })
    })

    $("#batchSetPrinters").on("click", function(){
        layer.open({
            title:"批量设置",
            type: 2,
            closeBtn: 1, //不显示关闭按钮
            shift: 2,
            maxmin: true,
            area: ['90%', '90%'],
            shadeClose: true, //开启遮罩关闭
            content: '$URL/merchant/admin/food/batchSetPrinters',
            end: function () {
                $("button[name='refresh']").click();
            }
        })
    })

    $("#foodImport").on("click", function(){
        layer.open({
            title:"菜品导入",
            type: 2,
            closeBtn: 1, //不显示关闭按钮
            shift: 2,
            maxmin: true,
            area: ['500px', '320px'],
            shadeClose: true, //开启遮罩关闭
            content: '$URL/merchant/admin/food/foodImport',
            end: function () {
                $("button[name='refresh']").click();
            }
        })
    })

    $("#foodOutput").on("click", function(){
        layer.confirm('确定导出？', {
            btn: ['导出','取消'] //按钮
        }, function(){
            var cateId = getCurrentChildrenId();
            window.open('$URL/merchant/admin/food/foodOutput?cateId=' + cateId);
            layer.closeAll("dialog");
        }, function(){
            layer.closeAll("dialog");
        });
    })

    function foodStateFormatter(value) {
        if(value ==1){
            return "不可用";
        }else {
            return "可用";
        }
    }

</script>
</body>
</html>
